name: Link Validation

on:
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch: # Allow manual trigger
  pull_request:
    branches: [main, master]
    paths:
      - 'docs/**/*.md'
      - 'docs/**/*.mdx'

jobs:
  link-check:
    name: Check All Links
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install lychee (link checker)
        run: |
          curl -L https://github.com/lycheeverse/lychee/releases/download/v0.14.3/lychee-v0.14.3-x86_64-unknown-linux-gnu.tar.gz | tar xz
          sudo mv lychee /usr/local/bin/

      - name: Run link check
        run: |
          lychee --verbose \
            --max-concurrency 8 \
            --exclude-mail \
            --exclude 'localhost:*' \
            --exclude 'http://127.0.0.1:*' \
            --exclude 'YOUR_APP_ID' \
            --exclude 'YOUR_SEARCH_API_KEY' \
            --exclude 'your-username' \
            --no-progress \
            --format markdown \
            'docs/**/*.md' 'docs/**/*.mdx' 'README.md' 'CONTRIBUTING.md' \
            > lychee-report.md || true

      - name: Display report
        run: cat lychee-report.md

      - name: Check for broken links
        run: |
          BROKEN_LINKS=$(grep -c "❌" lychee-report.md || echo "0")
          echo "Found ${BROKEN_LINKS} broken links"

          if [ "$BROKEN_LINKS" -gt 0 ]; then
            echo "❌ Broken links detected - see report above"
            cat lychee-report.md
            exit 1
          fi

          echo "✅ All links valid - zero dead links (SC-009)"

      - name: Upload link check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-check-report
          path: lychee-report.md
          retention-days: 30
